- name: "Gen password for {{endpoint.key}}"
  copy:
    content: "{%if gen_passwd %}{{lookup('password', '/dev/null chars=ascii_letters length=15')}}{%else%}{{endpoints[endpoint.key]['auth'][item.key]['password']}}{%endif%}"
    dest: "{{inventory_dir+'/credentials/'+endpoint.key+'_'+item.key+'.creds'}}"
    force: no
  with_dict:
  - "{{endpoint.value.auth}}"
  when: "endpoint.key != 'ceph_object_store' and item.key not in ['user', 'erlang_cookie']"

- name: Handle exceptions for rabbitmq
  block:
#  - name: "Gen password for {{endpoint.key}} - cookie"
#    copy:
#      content: "{%if gen_passwd %}{{lookup('password', '/dev/null chars=ascii_letters length=15')}}{%else%}{{endpoints[endpoint.key]['auth'][item.key]['cookie']}}{%endif%}"
#      dest: "{{inventory_dir+'/credentials/'+endpoint.key+'_erlang_cookie.creds'}}"
#      force: no
  - name: Get password for rabbitmq endpoint 'user'
    set_fact: 
      "oslo_messaging_user_pwd": "{{ lookup('file', inventory_dir+'/credentials/oslo_messaging_admin.creds') }}"
  when: "endpoint.key == 'oslo_messaging'"

- name: "Get password for {{endpoint.key}}"
  set_fact: 
    "{{endpoint.key}}_{{item.key}}_pwd": "{{ lookup('file', inventory_dir+'/credentials/'+endpoint.key+'_'+item.key+'.creds') }}"
  with_dict:
  - "{{endpoint.value.auth}}"
  when: "item.key != 'user'"

# Exception for s3 passwords
- name: "Passwords for {{endpoint.key}}"
  block:
  - name: "Gen password for {{endpoint.key}}"
    copy:
      content: "{%if gen_passwd %}{{lookup('password', '/dev/null chars=ascii_letters length=15')}}{%else%}{{endpoints[endpoint.key]['auth'][item.0][item.1]}}{%endif%}"
      dest: "{{inventory_dir+'/credentials/'+endpoint.key+'_'+item.0+'_'+item.1+'.creds'}}"
      force: no
    with_nested:
    - "{{endpoint.value.auth|list}}"
    - ['access_key', 'secret_key']
  - name: "Get password for {{endpoint.key}}"
    set_fact:
      "{{endpoint.key}}_{{item.0}}_{{item.1}}_pwd": "{{lookup('file', inventory_dir+'/credentials/'+endpoint.key+'_'+item.0+'_'+item.1+'.creds')}}"
    with_nested:
    - "{{endpoint.value.auth|list}}"
    - ['access_key', 'secret_key']
  when: "endpoint.key == 'ceph_object_store'"
